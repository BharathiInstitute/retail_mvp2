# Retail ERP MVP â€“ Flutter Shell

Modular, scalable Flutter 3.x app shell with Riverpod, GoRouter, Material 3, and Firebase placeholders.

## Tech stack

## Modules

## Structure
```
lib/
	app.dart                # MaterialApp.router + themes
	core/
		router/app_router.dart
		widgets/app_shell.dart, common_widgets.dart
		state/app_state.dart
		(features now self-contained; legacy models/services removed)
		(guards removed; role guard example now inline-commented in app_router.dart)
	features/
		<feature>/{ui,models,services}
```

## Firebase

Ensure Firebase is initialized via `firebase_options.dart` (generated by FlutterFire). The app initializes Firebase in `main.dart` using `DefaultFirebaseOptions.currentPlatform`.

### Firestore

- Rules file: `firestore.rules`
- To deploy rules (optional CLI step):

  1) Install Firebase CLI and login
  2) Initialize hosting if not already (optional)
  3) Deploy only rules

  See commands in the section below.

### Optional: Deploy Firestore rules via CLI

Prerequisites: Firebase CLI installed and authenticated; project set to `retail-erp-dc742`.

Commands (PowerShell):

```powershell
firebase use retail-erp-dc742
firebase deploy --only firestore:rules
```

## Run
1) Install deps
2) Run on any device/web

Notes: Firebase is not initialized. Mock providers make the UI render without backend. Replace mocks gradually with real services.

## CSV / XLSX Product Import & Export (Multi-Batch)

The app now supports multi-batch inventory with optional expiry dates. You can import or export variable numbers of batches per product.

### Base Columns (required / optional)
Import expects at least these columns (order flexible; header matching is case/space insensitive):

| Column | Required | Notes |
|--------|----------|-------|
| SKU | Yes | Unique (used as document id) |
| Name | Yes | Product name |
| Barcode | No | Must be numeric if present; unique across products |
| Unit Price | Yes | Decimal >= Cost Price and <= MRP |
| MRP | No | If blank defaults logic applies, must be >= Unit Price if provided |
| Cost Price | No | Must be <= Unit Price if provided |
| GST % | No | Allowed: 0,5,12,18 |
| Variants | No | Semi-colon separated list (A;B;C) |
| Description | No | Free text |
| Active | No | true/false/yes/no (default true) |
| Stock Store | No | Integer >=0 (used only if no batch columns supplied) |
| Stock Warehouse | No | Integer >=0 (used only if no batch columns supplied) |
| Supplier | No | Supplier identifier reference |

### Dynamic Batch Columns (optional)

Add any number of batches using repeating triplets:

```
Batch1 Qty, Batch1 Location, Batch1 Expiry, Batch2 Qty, Batch2 Location, Batch2 Expiry, ...
```

Rules:
* BatchN Qty: integer > 0 (rows with invalid or empty qty are ignored for that batch).
* BatchN Location: optional string (defaults to "Store" if blank).
* BatchN Expiry: optional date in ISO `yyyy-MM-dd` format (e.g., 2025-12-31). If invalid, expiry is ignored.
* If ANY BatchN columns are present for a row, the legacy Stock Store / Stock Warehouse fields are ignored for that row (batches drive the stock). If no batch columns appear or all batch qtys invalid, fallback to Store/Warehouse stock values.
* Batches are written to Firestore in order of Batch number (Batch1, Batch2, ...). Batch numbers must be sequential; missing numbers are skipped but do not stop later batches from being processed.

### Export Format

Export now produces:

```
tenantId,sku,name,barcode,unitPrice,taxPct,mrpPrice,costPrice,variants,description,isActive,storeQty,warehouseQty,totalQty,Batch1 Qty,Batch1 Location,Batch1 Expiry,Batch2 Qty,...
```

The number of batch triplets depends on the maximum batches among the exported products. Empty placeholders are left blank for products with fewer batches.

### Validation Summary
* Duplicate SKUs in file: rejected.
* Duplicate barcodes (in-file or existing different SKU in Firestore): rejected.
* Negative or non-numeric stock / qty: rejected.
* GST outside allowed set: rejected.
* MRP < Unit Price or Unit Price < Cost Price: rejected.

### Example Minimal File (no batches)
```
SKU,Name,Unit Price,Stock Store,Stock Warehouse
ABC123,Sample 1,120,10,0
```

### Example With Batches & Expiry
```
SKU,Name,Unit Price,Batch1 Qty,Batch1 Location,Batch1 Expiry,Batch2 Qty,Batch2 Location,Batch2 Expiry
ABC123,Sample 1,120,5,Store,2025-12-31,8,Warehouse,2026-01-15
```

If you need per-location defaulting or additional batch metadata fields, extend the repository batch map and import parsing similarly.
